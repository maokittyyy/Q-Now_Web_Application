<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scan MediCard | Q-Now</title>
  <style>
    :root {
      --primary: #0077cc;
      --primary-dark: #005fa3;
      --accent: #00aaff;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --text: #333;
      --text-light: #555;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
      --radius: 10px;
      --transition: all 0.25s ease;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--light-bg);
      color: var(--text);
      animation: fadeIn 0.5s ease;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    header h2 {
      margin: 0;
      font-size: 1.3rem;
      letter-spacing: 0.3px;
    }

    header a {
      color: white;
      text-decoration: none;
      transition: var(--transition);
    }

    header a:hover {
      color: var(--accent);
    }

    .container {
      max-width: 700px;
      margin: 40px auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: var(--shadow);
      animation: fadeUp 0.6s ease;
    }

    h1 {
      color: var(--primary-dark);
      text-align: center;
      margin-bottom: 10px;
    }

    p {
      text-align: center;
      color: var(--text-light);
      margin-bottom: 25px;
    }

    #scanInput {
      width: 100%;
      padding: 14px;
      font-size: 1.1rem;
      border: 2px solid var(--primary);
      border-radius: 8px;
      text-align: center;
      outline: none;
      transition: var(--transition);
      margin-bottom: 25px;
    }

    #scanInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 6px rgba(0, 119, 204, 0.3);
    }

    #patientInfo {
      display: none;
      border-top: 1px solid #ddd;
      padding-top: 20px;
      animation: fadeIn 0.5s ease;
    }

    h3 {
      color: var(--primary-dark);
      margin-bottom: 15px;
      text-align: center;
    }

    .info-block {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }

    .info-label {
      font-weight: 600;
      color: var(--primary-dark);
    }

    .actions {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: var(--transition);
    }

    .btn.add {
      background: #28a745;
      color: white;
    }

    .btn.add:hover {
      background: #218838;
    }

    .btn.view {
      background: #17a2b8;
      color: white;
    }

    .btn.view:hover {
      background: #138496;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: #777;
      font-size: 0.9rem;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>

<body>
  <header>
    <h2>Q-Now MediCard Scanner</h2>
    <a href="Q-Now.html">← Back</a>
  </header>

  <div class="container">
    <h1>Scan a MediCard</h1>
    <p>Place your cursor in the box and scan the patient's MediCard.</p>

    <input type="text" id="scanInput" placeholder="Awaiting scan..." autofocus />

    <div id="patientInfo">
      <h3>Patient Information</h3>
      <div class="info-block"><span class="info-label">Name:</span> <span id="pName">-</span></div>
      <div class="info-block"><span class="info-label">Email:</span> <span id="pEmail">-</span></div>
      <div class="info-block"><span class="info-label">Contact:</span> <span id="pContact">-</span></div>
      <div class="info-block"><span class="info-label">Health Info:</span> <span id="pHealth">-</span></div>
      <div class="info-block"><span class="info-label">Last Appointment:</span> <span id="pLastAppt">-</span></div>

      <div class="actions">
        <button class="btn add" id="btnAddToQueue">Add to Queue</button>
        <button class="btn view" id="btnViewAppts">View Appointments</button>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Q-Now. All rights reserved.</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA-VDEzKeVVpOwE7rds6ofNsKvxK3mWIlE",
      authDomain: "q-now-7d98a.firebaseapp.com",
      databaseURL: "https://q-now-7d98a-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "q-now-7d98a",
      storageBucket: "q-now-7d98a.firebasestorage.app",
      messagingSenderId: "72096271594",
      appId: "1:72096271594:web:b86777a11af444aac49b93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const scanInput = document.getElementById("scanInput");
    const patientInfoDiv = document.getElementById("patientInfo");
    const pName = document.getElementById("pName");
    const pEmail = document.getElementById("pEmail");
    const pContact = document.getElementById("pContact");
    const pHealth = document.getElementById("pHealth");
    const pLastAppt = document.getElementById("pLastAppt");
    const btnAddToQueue = document.getElementById("btnAddToQueue");
    const btnViewAppts = document.getElementById("btnViewAppts");
    let currentPatient = null;

    scanInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        const scannedData = scanInput.value.trim();
        if (!scannedData) return;

        db.ref("patients").orderByChild("qrCodeData").equalTo(scannedData).once("value")
          .then(snapshot => {
            if (!snapshot.exists()) {
              alert("❌ No matching MediCard found.");
              patientInfoDiv.style.display = "none";
              return;
            }
            snapshot.forEach(child => {
              const patient = child.val();
              currentPatient = { ...patient, uid: child.key };
              displayPatient(patient);
              db.ref(`patients/${child.key}/lastScan`).set(Date.now());
            });
          })
          .catch(err => alert("Error: " + err.message));
      }
    });

    function displayPatient(patient) {
      pName.textContent = patient.name || "N/A";
      pEmail.textContent = patient.email || "N/A";
      pContact.textContent = patient.contactNumber || "N/A";
      pHealth.textContent = patient.healthInfo || "N/A";
      pLastAppt.textContent = patient.lastAppointment || "None Recorded";
      patientInfoDiv.style.display = "block";
    }

    btnAddToQueue.onclick = () => {
      if (!currentPatient) return alert("Scan a MediCard first.");
      const estId = localStorage.getItem("currentEstablishmentId");
      const counterId = localStorage.getItem("currentCounterId");
      if (!estId || !counterId) {
        alert("Missing establishment or counter context.");
        return;
      }
      const queueRef = db.ref(`establishments/${estId}/counters/${counterId}/queue`);
      const newKey = queueRef.push().key;
      const queueEntry = {
        uid: currentPatient.uid,
        name: currentPatient.name,
        email: currentPatient.email,
        status: "waiting",
        joinTime: Date.now(),
        serviceStartTime: null,
        serviceEndTime: null
      };
      queueRef.child(newKey).set(queueEntry)
        .then(() => alert("✅ Added to queue successfully."))
        .catch(err => alert("Error adding to queue: " + err.message));
    };

    btnViewAppts.onclick = () => {
      if (!currentPatient) return alert("Scan a MediCard first.");
      window.location.href = `appointments.html?uid=${currentPatient.uid}`;
    };
  </script>
</body>
</html>
