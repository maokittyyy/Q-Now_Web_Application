<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Q-Now | Counter Management</title>

    <style>
        /* =========================
           Theme Variables
           ========================= */
        :root {
            --primary: #0077cc;
            --primary-dark: #005fa3;
            --accent: #00aaff;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --radius: 10px;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            --text: #333;
            --text-light: #555;
            --transition: all 0.25s ease;
        }

        /* =========================
           Global Styles
           ========================= */
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--text);
            animation: fadeInBody 0.6s ease;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            animation: slideDown 0.6s ease;
        }

        header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        header .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        header #counterDetails {
            color: white;
            text-align: right;
            font-size: 0.9rem;
        }

        header #counterLocation,
        header #counterPriority {
            margin: 2px 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: var(--transition);
            padding: 8px 12px;
        }

        .back-btn:hover {
            color: var(--accent);
            transform: translateY(-2px);
        }

        /* =========================
           Main Content
           ========================= */
        .container {
            max-width: 900px;
            margin: 30px auto;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: fadeUp 0.7s ease;
        }

        h2 {
            color: var(--primary-dark);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        h2:first-of-type {
            margin-top: 0;
        }

        .queue-item {
            background: #f9fbff;
            padding: 12px 15px;
            border: 1px solid #e0e7ef;
            border-radius: var(--radius);
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .queue-item:hover {
            background: #f0f8ff;
            transform: translateY(-2px);
        }

        .queue-item b {
            color: var(--primary-dark);
            font-size: 1.05rem;
        }

        .btn {
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 10px 16px;
            margin: 6px 4px 6px 0;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .next { background: #28a745; color: #fff; }
        .next:hover { background: #218838; }
        
        .reject { background: #dc3545; color: #fff; }
        .reject:hover { background: #c82333; }
        
        .toggle { background: var(--primary); color: #fff; }
        .toggle:hover { background: var(--primary-dark); }
        
        .accept { background: #17a2b8; color: #fff; }
        .accept:hover { background: #138496; }
        
        .end { background: #ffc107; color: #000; }
        .end:hover { background: #e0a800; }

        .small {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        #customerInfo {
            background: #f9fbff;
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid #e0e7ef;
            margin: 1rem 0;
        }

        #customerInfo h3 {
            color: var(--primary-dark);
            margin-top: 0;
        }

        #customerInfo p {
            margin: 8px 0;
            color: var(--text);
        }

        #customerInfo strong {
            color: var(--primary-dark);
        }

        /* =========================
           Animations
           ========================= */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInBody {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* =========================
           Collapsible Sections
           ========================= */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-dark);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            margin-top: 1.5rem;
            margin-bottom: 0;
            transition: var(--transition);
            user-select: none;
        }

        .section-header:hover {
            background: #004a80;
            transform: translateY(-1px);
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            background: #f9fbff;
            border: 1px solid #e0e7ef;
            border-top: none;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
            padding: 16px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            margin-bottom: 1rem;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
        }

        .section-empty {
            color: var(--text-light);
            font-style: italic;
            padding: 20px;
            text-align: center;
        }

        .section-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* =========================
           Current Customer Section
           ========================= */
        .current-customer-section {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 2rem;
            animation: fadeUp 0.6s ease;
        }

        .current-customer-section h2 {
            margin-top: 0;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .current-customer-section #customerInfo {
            background: white;
            border: 1px solid var(--primary);
            margin: 1rem 0 0 0;
        }

        .current-customer-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .current-customer-actions .btn {
            margin: 0;
            flex: 1;
            min-width: 150px;
        }

        /* =========================
           Patient Info Card (Clickable)
           ========================= */
        .patient-info-card {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
            border: 2px solid var(--primary);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 2rem;
            animation: fadeUp 0.6s ease;
            cursor: pointer;
            transition: var(--transition);
        }

        .patient-info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 119, 204, 0.2);
        }

        .patient-info-card h3 {
            margin: 0 0 12px 0;
            color: var(--primary-dark);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .patient-info-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .patient-info-item {
            display: flex;
            flex-direction: column;
        }

        .patient-info-label {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .patient-info-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .patient-info-card .open-profile {
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 8px;
            opacity: 0.7;
        }

        .accepting-toggle-container {
            margin-top: 2rem;
            padding: 16px;
            background: var(--light-bg);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-label {
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-checkbox {
            width: 50px;
            height: 28px;
            position: relative;
            cursor: pointer;
        }

        .toggle-checkbox input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-checkbox input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-checkbox input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            margin-left: 12px;
        }

        .toggle-status.open {
            background: #d4edda;
            color: #155724;
        }

        .toggle-status.closed {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <header>
        <h1 id="counterName">Counter</h1>
        <div class="header-actions">
            <div id="counterDetails">
                <div id="counterLocation"></div>
                <div id="counterPriority"></div>
            </div>
            <button class="back-btn" onclick="history.back()">‚Üê Back</button>
        </div>
    </header>

    <div class="container">
        <!-- =========================
             Patient Info Card (Clickable)
             ========================= -->
        <div class="patient-info-card" id="patientInfoCard" style="display: none;">
            <h3>üë§ Currently Being Served</h3>
            <div class="patient-info-details">
                <div class="patient-info-item">
                    <span class="patient-info-label">Name</span>
                    <span class="patient-info-value" id="patientInfoName">-</span>
                </div>
                <div class="patient-info-item">
                    <span class="patient-info-label">Age</span>
                    <span class="patient-info-value" id="patientInfoAge">-</span>
                </div>
                <div class="patient-info-item">
                    <span class="patient-info-label">Reason</span>
                    <span class="patient-info-value" id="patientInfoReason">-</span>
                </div>
                <div class="patient-info-item">
                    <span class="patient-info-label">Special Conditions</span>
                    <span class="patient-info-value" id="patientInfoConditions">None</span>
                </div>
            </div>
            <div class="patient-info-card .open-profile">üëÜ Click to view full details</div>
        </div>

        <!-- =========================
             Accepting Toggle
             ========================= -->
        <div class="accepting-toggle-container">
            <label class="toggle-label">
                <span>üîî Accepting Customers</span>
                <div class="toggle-checkbox">
                    <input type="checkbox" id="acceptToggle" />
                    <span class="toggle-slider"></span>
                </div>
            </label>
            <span class="toggle-status" id="toggleStatus">Offline</span>
        </div>

        <!-- =========================
             Requests Section
             ========================= -->
        <div>
            <div class="section-header" onclick="toggleSection(this)">
                <h2>
                    üìã Queue Requests
                    <span class="section-count" id="requestsCount">0</span>
                </h2>
                <span class="section-toggle"></span>
            </div>
            <div class="section-content">
                <div id="requestsList">
                    <div class="section-empty">No requests yet</div>
                </div>
            </div>
        </div>

        <!-- =========================
             Awaiting Arrival Section
             ========================= -->
        <div>
            <div class="section-header" onclick="toggleSection(this)">
                <h2>
                    üöó Awaiting Arrival
                    <span class="section-count" id="awaitingArrivalCount">0</span>
                </h2>
                <span class="section-toggle"></span>
            </div>
            <div class="section-content">
                <div id="awaitingArrivalList">
                    <div class="section-empty">No patients awaiting arrival</div>
                </div>
            </div>
        </div>

        <!-- =========================
             Queue (Waiting) Section
             ========================= -->
        <div>
            <div class="section-header" onclick="toggleSection(this)">
                <h2>
                    ‚è≥ Queue (Waiting)
                    <span class="section-count" id="queueCount">0</span>
                </h2>
                <span class="section-toggle"></span>
            </div>
            <div class="section-content">
                <div id="queueList">
                    <div class="section-empty">No one waiting</div>
                </div>
            </div>
        </div>

        <!-- =========================
             Counter Controls
             ========================= -->
        <h2 style="margin-top: 2rem;">Counter Controls</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn next" id="btnNext">‚û§ Admit Next</button>
            <button class="btn end" id="btnEndService" style="display: none;">‚úì End Service</button>
            <button class="btn reject" id="btnNoShow" style="display: none;">‚ö† Report as no-show</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
        /* =========================
           Collapsible Sections
           ========================= */
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector(".section-toggle");

            content.classList.toggle("collapsed");
            toggle.classList.toggle("collapsed");
        }

        /* =========================
           Update Section Counts
           ========================= */
        function updateSectionCount(elementId, count) {
            const countEl = document.getElementById(elementId);
            if (countEl) {
                countEl.textContent = count;
                countEl.style.display = count > 0 ? "inline-block" : "none";
            }
        }

        /* =========================
           Update Patient Info Card
           ========================= */
        function updatePatientInfoCard(data) {
            if (!data) {
                document.getElementById("patientInfoCard").style.display = "none";
                return;
            }

            document.getElementById("patientInfoName").textContent = data.name || data.patientName || "-";
            document.getElementById("patientInfoAge").textContent = data.age || "-";
            document.getElementById("patientInfoReason").textContent = data.reason || "-";

            let conditions = [];
            if (data.pwd) conditions.push("PWD");
            if (data.senior) conditions.push("Senior");
            if (data.severecon) conditions.push("Severe");
            document.getElementById("patientInfoConditions").textContent = conditions.length > 0 ? conditions.join(", ") : "None";

            document.getElementById("patientInfoCard").style.display = "block";
        }

        /* =========================
           Open Patient Detail Page
           ========================= */
        function openPatientDetail(uid) {
            if (!uid) {
                alert("Cannot open patient details for guest users.");
                return;
            }
            window.open(`Patient_Detail.html?uid=${uid}`, "_blank");
        }

/* ------------------------ FIREBASE CONFIG ------------------------ */

const firebaseConfig = {
    apiKey: "AIzaSyA-VDEzKeVVpOwE7rds6ofNsKvxK3mWIlE",
    authDomain: "q-now-7d98a.firebaseapp.com",
    databaseURL: "https://q-now-7d98a-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "q-now-7d98a",
    storageBucket: "q-now-7d98a.firebasestorage.app",
    messagingSenderId: "72096271594",
    appId: "1:72096271594:web:b86777a11af444aac49b93"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

/* ------------------------ URL PARAMETERS ------------------------ */

const urlParams = new URLSearchParams(window.location.search);
const estId = urlParams.get("estId");
const counterId = urlParams.get("counterId");

/* ------------------------ AUTH CHECK ------------------------ */

auth.onAuthStateChanged(user => {
    if (!user) {
        alert("Please log in first.");
        return;
    }
    initCounterPage();
});

function initCounterPage() {

    const counterRef = db.ref(`establishments/${estId}/counters/${counterId}`);
    const requestsRef = counterRef.child("requests");
    const queueRef = counterRef.child("queue");
    const acceptingRef = counterRef.child("accepting");

    const patientsRef = db.ref("patients");
    const estRef = db.ref(`establishments/${estId}`);

    const requestsList = document.getElementById("requestsList");
    const awaitingArrivalList = document.getElementById("awaitingArrivalList");
    const queueList = document.getElementById("queueList");
    const patientInfoCard = document.getElementById("patientInfoCard");

    const btnNext = document.getElementById("btnNext");
    const btnEndService = document.getElementById("btnEndService");
    const acceptToggle = document.getElementById("acceptToggle");
    const btnNoShow = document.getElementById("btnNoShow");
    const toggleStatus = document.getElementById("toggleStatus");

    const counterNameEl = document.getElementById("counterName");

    let currentCustomerKey = null;
    let currentCustomerData = null;

    /* ------------------ Load Establishment + Counter Name ------------------ */

    estRef.child("companyName").once("value").then(estSnap => {
        const estName = estSnap.val() || "Establishment";

        counterRef.child("name").once("value").then(cSnap => {
            const cName = cSnap.val() || "Counter";
            counterNameEl.textContent = `${estName} - ${cName}`;
        });
    });

    /* =========================================================================
   =====================  ACCEPTING REQUESTS TOGGLE  =========================
   ========================================================================== */

    acceptToggle.addEventListener("change", () => {
        const val = acceptToggle.checked;
        counterRef.update({ accepting: val });
    });

    counterRef.on("value", snap => {
        if (!snap.exists()) return;
        
        const counterData = snap.val();
        const isAccepting = counterData.accepting === true;
        
        acceptToggle.checked = isAccepting;
        toggleStatus.textContent = isAccepting ? "üü¢ Online" : "üî¥ Offline";
        toggleStatus.className = isAccepting ? "toggle-status open" : "toggle-status closed";
    });

    /* ------------------------------- LOAD REQUESTS -------------------------------- */

    requestsRef.on("value", snap => {

        requestsList.innerHTML = "";
        let requestCount = 0;

        if (!snap.exists()) {
            requestsList.innerHTML = "<div class=\"section-empty\">No requests yet</div>";
            updateSectionCount("requestsCount", 0);
            return;
        }

        snap.forEach(reqSnap => {

            requestCount++;

            const reqId = reqSnap.key;
            const reqData = reqSnap.val() || {};
            reqData.requestKey = reqId;

            const div = document.createElement("div");
            div.className = "queue-item";
            div.innerHTML = `
                <b>${reqData.patientName || "Unknown"}</b><br>
                <span class="small">Reason: ${reqData.reason || "-"}</span>
            `;

            const btnAccept = document.createElement("button");
            btnAccept.className = "btn accept";
            btnAccept.textContent = "Accept";

            const btnRejectReq = document.createElement("button");
            btnRejectReq.className = "btn reject";
            btnRejectReq.textContent = "Reject";

            div.appendChild(btnAccept);
            div.appendChild(btnRejectReq);
            requestsList.appendChild(div);

            /* ------------------------------ ACCEPT REQUEST ------------------------------ */

            btnAccept.onclick = async () => {

                const [estSnap, counterSnap] = await Promise.all([
                    estRef.child("companyName").once("value"),
                    counterRef.child("name").once("value")
                ]);

                const estName = estSnap.val() || "Unknown Establishment";
                const counterName = counterSnap.val() || "Unknown Counter";

                const awaitingKey = db.ref(`establishments/${estId}/counters/${counterId}/awaitingArrival`).push().key;
                const now = Date.now();

                const updates = {};
                let patientExtra = {};

                /* ------------- Fetch patient info if registered ------------ */

                if (reqData.uid) {
                    const pSnap = await db.ref(`patients/${reqData.uid}`).once("value");
                    const p = pSnap.val() || {};

                    patientExtra = {
                        name: p.name || reqData.patientName || "-",
                        age: p.age || null,
                        address: p.address || null,
                        phone: p.phone || null,
                        gender: p.gender || null,
                        contactNumber: p.contactNumber || null,
                        email: p.email || null,
                        pwd: p.pwd || false,
                        senior: p.senior || false,
                        severecon: p.severecon || false
                    };

                    // Remove request from patient node
                    if (reqData.requestKey) {
                        updates[`patients/${reqData.uid}/queueRequests/${reqData.requestKey}`] = null;
                    }
                }

                /* -------- Add to Awaiting Arrival instead of Queue -------- */

                updates[`establishments/${estId}/counters/${counterId}/awaitingArrival/${awaitingKey}`] =
                    Object.assign({}, reqData, patientExtra, {
                        status: "awaiting_arrival",
                        joinTime: now,
                        awaitingKey,
                        estId,
                        estName,
                        counterId,
                        counterName
                    });

                /* ---------------- Remove from Requests ---------------- */

                updates[`establishments/${estId}/counters/${counterId}/requests/${reqId}`] = null;

                /* ---------------- Patient Status Updates ---------------- */

                if (reqData.uid) {
                    updates[`patients/${reqData.uid}/queueStatus`] = {
                        status: "awaiting_arrival",
                        estId,
                        estName,
                        counterId,
                        counterName,
                        awaitingKey,
                        timestamp: now
                    };

                    updates[`patients/${reqData.uid}/activeQueues/${awaitingKey}`] = {
                        ...patientExtra,
                        estId,
                        estName,
                        counterId,
                        counterName,
                        awaitingKey,
                        joinTime: now,
                        status: "awaiting_arrival",
                        reason: reqData.reason || null
                    };

                    const notifKey =
                        db.ref(`patients/${reqData.uid}/notifications`).push().key;

                    updates[`patients/${reqData.uid}/notifications/${notifKey}`] = {
                        type: "queue",
                        estId,
                        estName,
                        counterId,
                        counterName,
                        message: "Queue request accepted. Please arrive at the establishment and scan your Health Pass.",
                        timestamp: now
                    };
                }

                await db.ref().update(updates);
            };

            /* ------------------------------ REJECT REQUEST ------------------------------ */

            btnRejectReq.onclick = async () => {

                const now = Date.now();
                const updates = {};

                updates[`establishments/${estId}/counters/${counterId}/requests/${reqId}`] = null;

                if (reqData.uid) {

                    if (reqData.requestKey) {
                        updates[`patients/${reqData.uid}/queueRequests/${reqData.requestKey}`] = null;
                    }

                    updates[`patients/${reqData.uid}/queueStatus`] = {
                        status: "rejected",
                        estId,
                        counterId,
                        timestamp: now
                    };

                    const notifKey =
                        db.ref(`patients/${reqData.uid}/notifications`).push().key;

                    updates[`patients/${reqData.uid}/notifications/${notifKey}`] = {
                        type: "queue",
                        estId,
                        counterId,
                        message: "Queue request rejected",
                        timestamp: now
                    };
                }

                await db.ref().update(updates);
            };

        }); // end forEach request

        updateSectionCount("requestsCount", requestCount);
    }); // end request listener

    /* ==========================================================================
       AWAITING ARRIVAL LIST (Template - no arrival logic yet)
       ========================================================================== */

    db.ref(`establishments/${estId}/counters/${counterId}/awaitingArrival`).on("value", snap => {

        awaitingArrivalList.innerHTML = "";
        let awaitingCount = 0;

        if (!snap.exists()) {
            awaitingArrivalList.innerHTML = "<div class=\"section-empty\">No patients awaiting arrival</div>";
            updateSectionCount("awaitingArrivalCount", 0);
            return;
        }

        snap.forEach(awaitingSnap => {

            awaitingCount++;

            const awaitingKey = awaitingSnap.key;
            const awaitingData = awaitingSnap.val() || {};

            const div = document.createElement("div");
            div.className = "queue-item";
            div.innerHTML = `
                <b>${awaitingData.patientName || awaitingData.name || "Unknown"}</b><br>
                <span class="small">Reason: ${awaitingData.reason || "-"}</span><br>
                <span class="small" style="color: #ffc107;">‚è± Awaiting Health Gate scan...</span>
            `;

            awaitingArrivalList.appendChild(div);

        });

        updateSectionCount("awaitingArrivalCount", awaitingCount);
    });

    /* ============================================================================
   =====================  NO-SHOW REPORT + TIMER LOGIC  ========================
   ============================================================================ */

/* Global interval for countdown */
let noShowInterval = null;

/* ----------------------------- REPORT NO-SHOW ----------------------------- */

btnNoShow.onclick = startNoShowReport;

async function startNoShowReport() {

    if (!currentCustomerKey || !currentCustomerData) {
        alert("No current customer to report.");
        return;
    }

    const uid = currentCustomerData.uid;

    if (!uid) {
        alert("Cannot report guest users as no-show.");
        return;
    }

    const queueKey = currentCustomerKey;
    const now = Date.now();
    const fiveMinutes = 5 * 60 * 1000;
    const expiresAt = now + fiveMinutes;

    const timerRef = db.ref(
        `establishments/${estId}/counters/${counterId}/noShowTimers/${queueKey}`
    );

    // Fetch establishment & counter names
    const [estSnap, counterSnap] = await Promise.all([
        estRef.child("companyName").once("value"),
        counterRef.child("name").once("value")
    ]);

    const estNameVal = estSnap.val() || "Unknown Establishment";
    const counterNameVal = counterSnap.val() || "Unknown Counter";

    // First warning notification
    const notifRef = db.ref(`patients/${uid}/notifications`).push();

    const updates = {};

    updates[`patients/${uid}/notifications/${notifRef.key}`] = {
        type: "queue",
        message:
            "‚ö† You have been marked as a no-show. Please proceed within 5 minutes.",
        estId,
        estName: estNameVal,
        counterId,
        counterName: counterNameVal,
        timestamp: now
    };

    // Timer record
    updates[
        `establishments/${estId}/counters/${counterId}/noShowTimers/${queueKey}`
    ] = {
        uid,
        queueKey,
        estId,
        counterId,
        estName: estNameVal,
        counterName: counterNameVal,
        createdAt: now,
        expiresAt,
        active: true
    };

    await db.ref().update(updates);

    alert("No-show reported. Timer started.");
    startCountdown(expiresAt, queueKey, uid, estNameVal, counterNameVal);
}

/* ----------------------- COUNTDOWN + EXPIRATION LOGIC ----------------------- */

const noShowIntervals = {}; // Store interval IDs per queueKey

function startCountdown(expiresAt, queueKey, uid, estName, counterName) {

    // Clear any existing interval for this specific queueKey
    if (noShowIntervals[queueKey]) {
        clearInterval(noShowIntervals[queueKey]);
    }

    // If this is the current customer being served, update the button
    if (currentCustomerKey === queueKey) {
        btnNoShow.onclick = () => cancelNoShow(queueKey);
    }

    noShowIntervals[queueKey] = setInterval(async () => {

        const now = Date.now();
        const remaining = expiresAt - now;

        // Update countdown display only if this is the current customer
        if (remaining > 0) {
            if (currentCustomerKey === queueKey) {
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                btnNoShow.innerHTML =
                    `‚ö† Cancel No-Show (${mins}:${secs.toString().padStart(2, "0")})`;
            }
            return;
        }

        // Time expired ‚Üí finalize no-show
        clearInterval(noShowIntervals[queueKey]);
        delete noShowIntervals[queueKey];

        await finalizeNoShow(queueKey, uid, estName, counterName);

    }, 1000);
}

async function finalizeNoShow(queueKey, uid, estName, counterName) {

    const timerRef = db.ref(`establishments/${estId}/counters/${counterId}/noShowTimers/${queueKey}`);
    const timerSnap = await timerRef.once("value");
    if (!timerSnap.exists()) return;

    // Remove from queue
    await db.ref(`establishments/${estId}/counters/${counterId}/queue/${queueKey}`).remove();

    // Delete timer entry
    await timerRef.remove();

    // Update patient record
    if (uid) {
        const updates = {};
        updates[`patients/${uid}/activeQueues/${queueKey}`] = null;
        updates[`patients/${uid}/queueStatus`] = {
            status: "no-show",
            estId,
            counterId,
            queueKey,
            timestamp: Date.now()
        };

        const notifFinal = db.ref(`patients/${uid}/notifications`).push();
        updates[`patients/${uid}/notifications/${notifFinal.key}`] = {
            type: "queue",
            message: "‚ùå You have been marked as a final no-show.",
            estId,
            estName,
            counterId,
            counterName,
            timestamp: Date.now()
        };

        await db.ref().update(updates);
    }

    // Increment analytics
    db.ref(`establishments/${estId}/counters/${counterId}/analytics/noShows`)
        .transaction(current => (current || 0) + 1);

    if (currentCustomerKey === queueKey) {
        btnNoShow.innerHTML = "‚ö† Report as no-show";
        btnNoShow.style.display = "none";
        btnEndService.style.display = "none";
        patientInfoCard.style.display = "none";
        currentCustomerKey = null;
        currentCustomerData = null;
    }
}

/* -------------------------------- CANCEL NO-SHOW -------------------------------- */

async function cancelNoShow(queueKey) {

    clearInterval(noShowInterval);

    const timerPath =
        `establishments/${estId}/counters/${counterId}/noShowTimers/${queueKey}`;

    const timerRef = db.ref(timerPath);
    const timerSnap = await timerRef.once("value");

    if (!timerSnap.exists()) {
        alert("Timer already removed.");
        return;
    }

    const timerData = timerSnap.val();

    const uid = timerData.uid;
    const estName = timerData.estName;
    const counterName = timerData.counterName;

    // Send cancellation notification (if patient exists)
    if (uid) {
        const notifRef = db.ref(`patients/${uid}/notifications`).push();

        await notifRef.set({
            type: "queue",
            message:
                "‚ÑπÔ∏è Your no-show report has been cancelled. Thank you for responding promptly!",
            estId,
            estName,
            counterId,
            counterName,
            timestamp: Date.now()
        });
    }

    // Remove timer
    await timerRef.remove();

    alert("No-show canceled.");

    // Reset UI
    btnNoShow.innerHTML = "‚ö† Report as no-show";
    btnNoShow.onclick = startNoShowReport;
}

/* ============================================================================
   ===============  DETECT CUSTOMER ENTERING IN-SERVICE  ======================
   ============================================================================ */

queueRef
    .orderByChild("status")
    .equalTo("in_service")
    .on("child_added", async snap => {

        const data = snap.val() || {};
        const key = snap.key;

        console.log("Detected in-service customer:", data);

        // Prevent triggering twice for same person
        if (currentCustomerKey === key) return;

        currentCustomerKey = key;
        currentCustomerData = data;
        patientInfoCard.style.display = "block";
        btnEndService.style.display = "inline-block";
        btnNoShow.style.display = "inline-block";

        // Disable admit button while someone is being served
        btnNext.disabled = true;

        /* ------------------- Update patient info card ------------------- */
        updatePatientInfoCard(data);

        /* ------------------- Load Establishment + Counter Names + Details -------- */

        const [estSnap, counterSnap] = await Promise.all([
            estRef.child("companyName").once("value"),
            counterRef.child("name").once("value"),
            counterRef.child("location").once("value"),
            counterRef.child("priorityLane").once("value")
        ]);

        /* ------------------- Send "now in service" notification ------------------- */

        if (data.uid) {
            try {
                const now = Date.now();
                const estNameVal = estSnap.val() || "Unknown Establishment";
                const counterNameVal = counterSnap.val() || "Unknown Counter";

                const notifRef = db
                    .ref(`patients/${data.uid}/notifications`)
                    .push();

                await notifRef.set({
                    type: "queue",
                    estId,
                    estName: estNameVal,
                    counterId,
                    counterName: counterNameVal,
                    message: "You are now in service.",
                    timestamp: now
                });

                console.log("In-service notification sent:", notifRef.key);
            } catch (err) {
                console.error("Error sending in-service notification:", err);
            }
        }
    });

    /* ============================================================================
   =====================  QUEUE WAITING LIST DISPLAY  =========================
   ============================================================================ */

queueRef
    .orderByChild("status")
    .equalTo("waiting")
    .on("value", snap => {

        queueList.innerHTML = "";
        let queueItemCount = 0;

        if (!snap.exists()) {
            queueList.innerHTML = "<div class=\"section-empty\">No one waiting</div>";
            updateSectionCount("queueCount", 0);
            return;
        }

        snap.forEach(c => {
            queueItemCount++;
            const v = c.val() || {};

            const el = document.createElement("div");
            el.className = "queue-item";

            el.innerHTML = `
                <b>${v.patientName || v.name || "Unknown"}</b><br>
                <span class="small">Reason: ${v.reason || "-"}</span>
            `;

            queueList.appendChild(el);
        });

        updateSectionCount("queueCount", queueItemCount);
    });

    /* ============================================================================
   ============================  ADMIT NEXT  =================================
   ============================================================================ */

btnNext.onclick = async () => {

    // Get first waiting customer
    const snap = await queueRef
        .orderByChild("status")
        .equalTo("waiting")
        .limitToFirst(1)
        .once("value");

    if (!snap.exists()) {
        alert("No one waiting.");
        return;
    }

    snap.forEach(async s => {

        const key = s.key;
        const data = s.val() || {};
        const now = Date.now();

        const updates = {};

        /* ---------------- Set status ‚Üí in_service ---------------- */
        updates[
            `establishments/${estId}/counters/${counterId}/queue/${key}/status`
        ] = "in_service";

        updates[
            `establishments/${estId}/counters/${counterId}/queue/${key}/serviceStartTime`
        ] = now;

        /* ---------------- Update patient active queue ---------------- */

        if (data.uid) {
            updates[`patients/${data.uid}/activeQueues/${key}/status`] =
                "in_service";

            updates[
                `patients/${data.uid}/activeQueues/${key}/serviceStartTime`
            ] = now;

            updates[`patients/${data.uid}/queueStatus`] = {
                status: "in_service",
                estId,
                counterId,
                queueKey: key,
                timestamp: now
            };
        }

        await db.ref().update(updates);

        /* ---------------- Store as current customer ---------------- */

        currentCustomerKey = key;
        currentCustomerData = data;
        patientInfoCard.style.display = "block";
        btnEndService.style.display = "inline-block";
        btnNoShow.style.display = "inline-block";

        /* ------------------- Update patient info card ------------------- */
        updatePatientInfoCard(data);
    });
};

/* ============================================================================
   ============================  END SERVICE  =================================
   ============================================================================ */

btnEndService.onclick = async () => {

    if (!currentCustomerKey || !currentCustomerData) {
        alert("No current customer.");
        return;
    }

    const now = Date.now();

    const qDataSnap = await queueRef.child(currentCustomerKey).once("value");

    if (!qDataSnap.exists()) return;

    const qData = qDataSnap.val() || {};

    const join = qData.joinTime || now;
    const start = qData.serviceStartTime || now;

    const waitMs = start - join;
    const serviceMs = now - start;

    /* ---------------- Fetch establishment + counter names ---------------- */

    const [estSnap, counterSnap] = await Promise.all([
        estRef.child("companyName").once("value"),
        counterRef.child("name").once("value")
    ]);

    const estNameVal = estSnap.val() || "Unknown Establishment";
    const counterNameVal = counterSnap.val() || "Unknown Counter";

    const updates = {};

    /* ---------------- Mark queue entry as done ---------------- */

    updates[
        `establishments/${estId}/counters/${counterId}/queue/${currentCustomerKey}/status`
    ] = "done";

    updates[
        `establishments/${estId}/counters/${counterId}/queue/${currentCustomerKey}/serviceEndTime`
    ] = now;

    /* ---------------- Registered users: save visit record ---------------- */

    if (qData.uid) {

        const visitKey =
            db.ref().child("patients").child(qData.uid).child("visited").push().key;

        updates[`patients/${qData.uid}/visited/${visitKey}`] = {
            estId,
            estName: estNameVal,
            counterId,
            counterName: counterNameVal,
            joinTime: join,
            serviceStartTime: start,
            serviceEndTime: now,
            waitMs,
            serviceMs,
            timestamp: now,
            reason: qData.reason || null
        };

        // Clear active queue
        updates[`patients/${qData.uid}/activeQueues/${currentCustomerKey}`] =
            null;

        updates[`patients/${qData.uid}/queueStatus`] = null;

        // Notification: service finished
        const notifKey =
            db.ref(`patients/${qData.uid}/notifications`).push().key;

        updates[`patients/${qData.uid}/notifications/${notifKey}`] = {
            type: "queue",
            estId,
            estName: estNameVal,
            counterId,
            counterName: counterNameVal,
            message: "Patient has finished service",
            timestamp: now
        };
    }

    await db.ref().update(updates);

    /* ---------------- Reset UI ---------------- */

    patientInfoCard.style.display = "none";
    btnEndService.style.display = "none";
    btnNoShow.style.display = "none";

    currentCustomerKey = null;
    currentCustomerData = null;
    btnNext.disabled = false;
};

/* ------------------- Add click handler for patient info card ------------------- */
document.getElementById("patientInfoCard").addEventListener("click", () => {
    if (currentCustomerData && currentCustomerData.uid) {
        openPatientDetail(currentCustomerData.uid);
    }
});

/* --------------------------- RESTORE NO-SHOW TIMERS --------------------------- */

function restoreNoShowTimers() {
    const timersRef = db.ref(`establishments/${estId}/counters/${counterId}/noShowTimers`);
    timersRef.orderByChild("active").equalTo(true).once("value", snap => {
        if (!snap.exists()) return;

        snap.forEach(timerSnap => {
            const t = timerSnap.val();
            const queueKey = t.queueKey;
            const uid = t.uid;
            const expiresAt = t.expiresAt;

            if (expiresAt <= Date.now()) {
                finalizeNoShow(queueKey, uid, t.estName, t.counterName);
            } else {
                startCountdown(expiresAt, queueKey, uid, t.estName, t.counterName);
            }
        });
    });
}

// Call this at the end of initCounterPage
restoreNoShowTimers();
}

</script>
</body>
</html>
