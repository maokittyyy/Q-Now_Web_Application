<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Q-now | Establishment Dashboard</title>

<style>
  :root {
    --primary: #0077cc;
    --primary-dark: #005fa3;
    --accent: #00aaff;
    --success: #28a745;
    --danger: #dc3545;
    --light-bg: #f5f7fa;
    --card-bg: #ffffff;
    --text: #333;
    --text-light: #555;
    --shadow: 0 4px 10px rgba(0,0,0,0.08);
    --radius: 10px;
    --transition: all 0.25s ease;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--light-bg);
    color: var(--text);
    animation: fadeInBody 0.6s ease;
  }

  header {
    background: var(--primary);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    animation: slideDown 0.5s ease;
  }

  header h2 { margin: 0; font-size: 1.3rem; }
  header a { color: white; text-decoration: none; transition: var(--transition); }
  header a:hover { color: var(--accent); transform: translateY(-2px); }

  .container {
    max-width: 1100px;
    margin: 30px auto;
    padding: 25px;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    animation: fadeUp 0.7s ease;
  }

  h1, h2 { color: var(--primary-dark); margin-top: 0; }
  p { color: var(--text-light); }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .card {
    background: white;
    border-radius: var(--radius);
    padding: 1.2rem 1.5rem;
    box-shadow: var(--shadow);
    transition: var(--transition);
    text-align: center;
  }

  .card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }

  .card h3 { color: var(--primary-dark); margin-bottom: 0.5rem; }
  .card p { color: var(--text-light); margin-bottom: 1rem; font-size: 0.95rem; }

  .btn {
    display: inline-block;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    text-decoration: none;
  }

  .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
  .btn.open { background: var(--success); }
  .btn.closed { background: var(--danger); }
  .btn.manage { background: var(--accent); }

  .counter {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #f9f9f9;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 10px;
    transition: var(--transition);
  }

  .counter:hover { background: #f0f8ff; transform: translateY(-2px); }
  .counter input { border: none; font-size: 1rem; font-weight: 600; background: transparent; width: 160px; color: var(--primary-dark); }

  canvas { max-width: 100%; margin-top: 10px; }

  footer {
    text-align: center;
    padding: 20px;
    margin-top: 40px;
    background: #eef3f8;
    color: #666;
    font-size: 0.9rem;
    animation: fadeInBody 1.2s ease;
  }

  /* Animations */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeInBody { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>

<header>
  <h2>Establishment Dashboard</h2>
  <a href="Q-Now.html">‚Üê Back to Home</a>
</header>

<div class="container">
  <h1 id="establishmentName">Establishment</h1>
  <p>Manage queues, appointments, counters, and analytics for this facility.</p>

  <h2>Features</h2>
  <div class="grid">
    <div class="card">
      <h3>Appointments</h3>
      <p id="appointmentPreview">Loading next appointment...</p>
      <a href="Appointments.html" class="btn">Open Appointments</a>
    </div>
    <div class="card">
      <h3>Live Queue</h3>
      <p id="queuePreview">Loading...</p>
      <a href="Live_Queue.html" class="btn">Open Live Queue</a>
    </div>
    <div class="card">
      <h3>Analytics</h3>
      <p id="analyticsPreview">Loading...</p>
      <canvas id="analyticsChart"></canvas>
      <a href="Analytics.html" class="btn">Open Analytics</a>
    </div>
    <div class="card">
      <h3>MediCard Scanning</h3>
      <p>Scan patient MediCards now</p>
      <a href="Search.html" class="btn">Search Database</a>
    </div>

  </div>

  <h2 style="margin-top: 40px;">Counters</h2>
  <div id="countersList"></div>
  <button class="btn" onclick="addCounter()">+ Add Counter</button>
</div>

<footer>
  <p>&copy; 2025 Q-now. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA-VDEzKeVVpOwE7rds6ofNsKvxK3mWIlE",
    authDomain: "q-now-7d98a.firebaseapp.com",
    databaseURL: "https://q-now-7d98a-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "q-now-7d98a",
    storageBucket: "q-now-7d98a.firebasestorage.app",
    messagingSenderId: "72096271594",
    appId: "1:72096271594:web:b86777a11af444aac49b93"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const urlParams = new URLSearchParams(window.location.search);
  const estId = urlParams.get("id");

  const countersRef = ref(db, `establishments/${estId}/counters`);
  const establishmentRef = ref(db, `establishments/${estId}`);
  const appointmentsRef = ref(db, `establishments/${estId}/appointments`);

  const appointmentPreview = document.getElementById("appointmentPreview");
  const countersList = document.getElementById("countersList");
  const establishmentName = document.getElementById("establishmentName");
  const queuePreview = document.getElementById("queuePreview");
  const analyticsPreview = document.getElementById("analyticsPreview");
  const analyticsChartCtx = document.getElementById("analyticsChart").getContext("2d");
  let analyticsChart;
  let counterNameCache = {};

  // Display establishment info
  onValue(establishmentRef, snap => {
    if (!snap.exists()) return;
    const data = snap.val();
    establishmentName.textContent = data.companyName || "Establishment";
    if (data.counters) {
      counterNameCache = {};
      Object.entries(data.counters).forEach(([cid, c]) => {
        counterNameCache[cid] = c.name || "Counter";
      });
    }
  });

  // --- Appointment Preview ---
  onValue(appointmentsRef, snapshot => {
    if (!snapshot.exists()) {
      appointmentPreview.textContent = "No appointments yet.";
      return;
    }

    let upcoming = null;
    const now = new Date();

    snapshot.forEach(child => {
      const appt = child.val();
      if (!appt || appt.status === "cancelled" || appt.status === "rejected") return;

      let slotList = Array.isArray(appt.slots) ? appt.slots : Object.values(appt.slots || {});
      if (!slotList.length) return;

      slotList.sort((a, b) => new Date(`${a.date}T${a.time}:00`) - new Date(`${b.date}T${b.time}:00`));
      const slot = slotList[0];
      const apptTime = new Date(`${slot.date}T${slot.time}:00`);
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      if (apptTime >= startOfToday && (!upcoming || apptTime < upcoming._time)) {
        upcoming = { ...appt, _time: apptTime, slot };
      }
    });

    if (!upcoming) {
      appointmentPreview.textContent = "No upcoming appointments.";
      return;
    }

    const slot = upcoming.slot;
    const dateStr = new Date(`${slot.date}T${slot.time}:00`).toLocaleString("en-PH", {
      weekday: "short", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit", hour12: true
    });

    appointmentPreview.innerHTML = `
      üïí <strong>${dateStr}</strong><br>
      üë§ ${upcoming.patientName || "Unknown"}<br>
      üìç ${upcoming.address || "No address provided"}<br>
      üìû ${upcoming.contactNumber || upcoming.phone || "No contact"}<br>
      ‚≠ê Priority: ${upcoming.priority || "Normal"}
    `;
  });

  // --- Queue Preview ---
  onValue(countersRef, snapshot => {
    let waiting = 0, servingDetail = null;
    snapshot.forEach(counterSnap => {
      const counter = counterSnap.val();
      if (!counter.queue) return;
      Object.values(counter.queue).forEach(cust => {
        if (cust.status === "waiting") waiting++;
        if (cust.status === "in_service" && !servingDetail) {
          servingDetail = `${cust.patientName || "Unknown"} (${cust.age || "?"} y/o)`;
        }
      });
    });
    queuePreview.textContent = waiting === 0 && !servingDetail
      ? "No active queue."
      : `${waiting} waiting ‚Ä¢ ${servingDetail ? "Serving: " + servingDetail : "None serving"}`;
  });

  // --- Analytics ---
onValue(ref(db, "patients"), pSnap => {
  let totalWait = 0, totalService = 0, totalNoShows = 0, count = 0;
  const counterStats = {};

  pSnap.forEach(p => {
    if (!p.child("visited").exists()) return;
    p.child("visited").forEach(v => {
      const vData = v.val();
      if (vData.estId !== estId) return;
      const counterId = vData.counterId;
      if (!counterStats[counterId]) counterStats[counterId] = { wait: 0, service: 0, count: 0, noShows: 0 };
      counterStats[counterId].wait += vData.waitMs || 0;
      counterStats[counterId].service += vData.serviceMs || 0;
      counterStats[counterId].count++;
      totalWait += vData.waitMs || 0;
      totalService += vData.serviceMs || 0;
      count++;
    });
  });

  // Fetch No-Shows per counter
  onValue(countersRef, cSnap => {
    cSnap.forEach(c => {
      const cid = c.key;
      const analytics = c.child("analytics");
      if (analytics.exists() && analytics.child("noShows").exists()) {
        const noShows = analytics.child("noShows").val();
        if (!counterStats[cid]) counterStats[cid] = { wait: 0, service: 0, count: 0, noShows: 0 };
        counterStats[cid].noShows = noShows;
        totalNoShows += noShows;
      }
    });

    if (count === 0 && totalNoShows === 0) {
      analyticsPreview.textContent = "No data yet.";
      if (analyticsChart) analyticsChart.destroy();
    } else {
      const avgWait = count ? (totalWait / count / 60000).toFixed(1) : 0;
      const avgService = count ? (totalService / count / 60000).toFixed(1) : 0;
      analyticsPreview.textContent = `Overall Avg Wait: ${avgWait} min ‚Ä¢ Service: ${avgService} min ‚Ä¢ Total No-Shows: ${totalNoShows}`;

      const labels = [], waitData = [], serviceData = [], noShowData = [];
      Object.entries(counterStats).forEach(([cid, c]) => {
        const cname = counterNameCache[cid] || "Counter";
        labels.push(cname);
        waitData.push(c.count ? (c.wait / c.count / 60000).toFixed(1) : 0);
        serviceData.push(c.count ? (c.service / c.count / 60000).toFixed(1) : 0);
        noShowData.push(c.noShows || 0);
      });

      if (analyticsChart) analyticsChart.destroy();
      analyticsChart = new Chart(analyticsChartCtx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Avg Wait (min)", data: waitData, backgroundColor: "#0077cc" },
            { label: "Avg Service (min)", data: serviceData, backgroundColor: "#28a745" },
            { label: "No-Shows", data: noShowData, backgroundColor: "#dc3545" }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
        }
      });
    }
  });
});


  // --- Counter Management ---
  onValue(countersRef, snapshot => {
    countersList.innerHTML = "";
    snapshot.forEach(child => {
      const counter = child.val(), key = child.key;
      const div = document.createElement("div");
      div.className = "counter";

      const nameInput = document.createElement("input");
      nameInput.value = counter.name || "Unnamed Counter";
      nameInput.onchange = () => update(ref(db, `establishments/${estId}/counters/${key}`), { name: nameInput.value });

      const isOpen = counter.open ?? true;
      const statusBtn = document.createElement("button");
      statusBtn.className = "btn " + (isOpen ? "open" : "closed");
      statusBtn.textContent = isOpen ? "Open" : "Closed";
      statusBtn.onclick = () => update(ref(db, `establishments/${estId}/counters/${key}`), { open: !isOpen , accepting: !isOpen });

      const manageBtn = document.createElement("button");
      manageBtn.className = "btn manage";
      manageBtn.textContent = "Manage";
      manageBtn.onclick = () => window.location.href = `counter.html?estId=${estId}&counterId=${key}`;

      div.appendChild(nameInput);
      div.appendChild(statusBtn);
      div.appendChild(manageBtn);
      countersList.appendChild(div);
    });
  });

  function addCounter() {
    const newCounterRef = push(countersRef);
    set(newCounterRef, { name: "New Counter", open: true , accepting: true, queue: {}});
  }
  window.addCounter = addCounter;
</script>
</body>
</html>
